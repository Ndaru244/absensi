<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistem Absensi Digital</title>
    <meta name="description" content="Masuk ke Sistem Absensi Digital untuk mengelola kehadiran siswa secara real-time.">
    <link rel="icon" type="image/png" href="assets/images/logo.png">
    <meta property="og:title" content="Login Absensi Digital">
    <meta property="og:description" content="Akses manajemen kehadiran siswa berbasis Cloud.">
    <meta property="og:image" content="assets/images/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { darkbg: '#0f172a', darkcard: '#1e293b' } } }
        }
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
    <style>
        .loader {
            border-top-color: #3b82f6;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Optimistic UI: Fade in animation */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-darkbg text-gray-800 dark:text-gray-200 min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full bg-white dark:bg-darkcard rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden fade-in">
    <div class="p-8">
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gray-50 dark:bg-gray-800 mb-4 shadow-inner">
                <img src="assets/images/logo.png" alt="Logo Absensi" class="w-16 h-16 object-contain">
            </div>
            
            <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight uppercase">ABSENSI</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Masuk untuk mengelola kehadiran siswa</p>
        </div>

        <div class="space-y-4">
            <button id="btnGoogleLogin"
                class="w-full flex items-center justify-center gap-3 bg-white hover:bg-gray-50 text-gray-700 font-semibold py-3 px-4 rounded-xl border border-gray-300 shadow-sm transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                <img id="g-logo" src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png"
                    class="w-5 h-5" alt="Google Logo">
                <div id="loader-icon" class="hidden loader w-5 h-5 border-2 border-gray-200 rounded-full"></div>
                <span id="btn-text">Masuk dengan Google</span>
            </button>

            <div id="status-message" class="hidden text-center text-sm">
                <div class="flex items-center justify-center gap-2 text-blue-600 dark:text-blue-400">
                    <div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    <span id="status-text">Memverifikasi...</span>
                </div>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t dark:border-gray-700 text-center">
            <p class="text-xs text-gray-400 flex justify-center items-center gap-1">
                <i data-lucide="life-buoy" class="w-3 h-3"></i> Pusat Bantuan: IT Support Absensi
            </p>
        </div>
    </div>
</div>

    <script type="module">
        import { initAuthGuard } from './assets/js/utils/auth-guard.js';
        import { authService } from './assets/js/firebase/auth-service.js';
        import { auth } from './assets/js/firebase/config.js';

        // Initialize auth guard with preventLoginAccess
        initAuthGuard({ preventLoginAccess: true });

        lucide.createIcons();

        const btn = document.getElementById('btnGoogleLogin');
        const btnText = document.getElementById('btn-text');
        const loader = document.getElementById('loader-icon');
        const gLogo = document.getElementById('g-logo');
        const statusMessage = document.getElementById('status-message');
        const statusText = document.getElementById('status-text');

        // OPTIMIZED: Single click handler with debounce
        let isProcessing = false;

        btn.addEventListener('click', async () => {
            if (isProcessing) return; // Prevent double click
            
            isProcessing = true;
            setLoading(true, "Membuka jendela login...");

            try {
                // Step 1: Login with Google
                const userData = await authService.loginWithGoogle();

                if (!userData) {
                    throw new Error('Gagal mendapatkan data user');
                }

                // Step 2: Quick validation from cache (instant!)
                setLoading(true, "Memverifikasi akun...");

                // Step 3: Redirect based on role
                if (userData.role === 'admin') {
                    setLoading(true, "Menuju Admin Panel...");
                    // Small delay for better UX
                    await new Promise(resolve => setTimeout(resolve, 300));
                    window.location.replace('admin.html');
                } else if (userData.isVerified) {
                    setLoading(true, "Menuju Dashboard...");
                    await new Promise(resolve => setTimeout(resolve, 300));
                    window.location.replace('index.html');
                } else {
                    // Unverified user
                    alert("Akun belum diverifikasi Admin.");
                    await authService.logout();
                    resetBtn();
                    isProcessing = false;
                }

            } catch (error) {
                // Handle specific errors
                if (error.code === 'auth/popup-closed-by-user') {
                    console.log("User closed login window");
                } else if (error.code === 'auth/cancelled-popup-request') {
                    console.log("Popup request cancelled");
                } else {
                    console.error('Login error:', error);
                    alert("Gagal Masuk: " + (error.message || 'Unknown error'));
                }
                
                resetBtn();
                isProcessing = false;
            }
        });

        function setLoading(show, message = "Memproses...") {
            btn.disabled = show;
            
            if (show) {
                btnText.innerText = message;
                gLogo.classList.add('hidden');
                loader.classList.remove('hidden');
                statusMessage.classList.remove('hidden');
                statusText.innerText = message;
            } else {
                btnText.innerText = "Masuk dengan Google";
                gLogo.classList.remove('hidden');
                loader.classList.add('hidden');
                statusMessage.classList.add('hidden');
            }
        }

        function resetBtn() {
            setLoading(false);
        }

        // Preload destination pages for faster navigation
        const preloadLinks = ['admin.html', 'index.html'];
        preloadLinks.forEach(href => {
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = href;
            document.head.appendChild(link);
        });
    </script>
</body>

</html>